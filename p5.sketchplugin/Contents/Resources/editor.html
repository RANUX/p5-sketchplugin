<!doctype html>
<html>

<head>
	<link rel="stylesheet" href="codemirror.css" />

	<script type="text/javascript" src="codemirror.js"></script>
	<script type="text/javascript" src="javascript.js"></script>
	<script type="text/javascript" src="jquery-3.2.1.min.js"></script>

	<style>
		body,
		html {
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
		}

		body {
			border: none;
			box-sizing: border-box;
		}

		button {
			width: 30px;
			height: 30px;
			border-radius: 15px;
			border: none;
			color: #ed225d;
			background-color: #f4f4f4;
		}

		button:hover {
			color: #f4f4f4;
			background-color: #ed225d;
		}

		.CodeMirror {
			height: 90%;
			width: 100%;
			border-top: 1px solid #ddd;
		}

		.header {
			height: 10%;
			font-family: Helvetica, Arial, sans-serif;
			font-size: 12px;
			margin-left: 10px;
		}

		.preset {
			float: right;
		}
	</style>
</head>

<body>
	<div class="header">
		<button onclick="updateHash()">&#9658;</button>
		<span class="preset">
			<span>Select from preset:</span><br>
		<select>
				<option value="latest">Latest sketch</option>
				<option value="pieChart">Pie chart</option>
				<option value="basic">Basic sketch</option>
				<option value="demo">Demo</option>
				<option value="get">Get</option>
			</select>
		</span>
	</div>
	<script type="text/javascript">
		//update the window.location hash to tell Sketch that we are ready to Run
		function updateHash() {
			window.location.hash = "run" + new Date().getTime();;
		}

		/*I tried to code this on the plugin side but without success. So the file is actually loaded in the editor by the webview*/
		function getLatest() {
			jQuery.get({
			url: '../Sketch/sketch.js',
			cache: false
			}).then(function(data) {
				var code = data.replace(/\brectangle\b/g,'rect');
				console.log(code);
				setValue(code);
			});
		};

		var options = {
			lineNumbers: true,
			autofocus: true,
			lineWrapping: true
		};
		var myCodeMirror = CodeMirror(document.body, options);

		var initialValue = getLatest();
		var defaultValue = "function setup() {\n	createCanvas(200, 200) //set up a 200x200 px artboard\n}\n\nfunction draw() {\n	line(0, 0, 100, 100);//draw a line from 0,0 to 100,100\n}"

		var getValue = function() {
			return myCodeMirror.getValue();
		};
		var setValue = function(value) {
			myCodeMirror.setValue(value);
		};

		var pieChart =`var angles = [ 30, 10, 45, 35, 60, 38, 75, 67 ];

function setup() {
  createCanvas(720, 400);
  noStroke();
  noLoop();  // Run once and stop
}

function draw() {
  background(100);
  pieChart(300, angles);
}

function pieChart(diameter, data) {
  var lastAngle = 0;
  for (var i = 0; i < data.length; i++) {
    var gray = map(i, 0, data.length, 0, 255);
    fill(gray);
    arc(width/2, height/2, diameter, diameter, lastAngle, lastAngle+radians(angles[i]));
    lastAngle += radians(angles[i]);
  }
}`;

		var demo =`function setup() {
	createCanvas(500, 500);
	background(0,255,0);
}

function draw() {
  	textSize(24)
    textFont('Georgia')
    fill('#0000FF')
    stroke('#FF0000')
    strokeWeight(8)
    point(100,100);
  	line(0,0,100,100)
    rect(0,0,100,200)
    quad(0,0,100,200,400,400,200,90)
    triangle(0,0,100,200,400,400)
    ellipse(250,250,500,100)
    arc(250,250,500,100,0,PI)
    text('Hello world',10,10,100,200)
    bezier(85, 20, 10, 10, 90, 90, 15, 80);
}`;

		var get = `json = get(['http://api.open-notify.org/astros.json'])

function setup() {
	createCanvas(200, 200)
}

function draw() {
  noStroke();
  fill(0);
  text("Astronauts in space now: "+json.number,10,40,200,20);
  textSize(14);
  translate(0,65);
    for (x=0;x<json.people.length;x++) {
	text(json.people[x].name,10,x*15,200,20);
  }
}`;

		$('select').on('change', function() {
			if (this.value == "basic") {
				setValue(defaultValue);
			} else if (this.value == "latest") {
				getLatest();
			} else if (this.value == "pieChart") {
				setValue(pieChart);
			} else if (this.value == "demo") {
				setValue(demo);
			} else if (this.value == "get") {
				setValue(get);
			}
		});

		document.body.addEventListener('keydown', function(e) {
			if (!(e.keyCode == 13 && e.metaKey)) return;
			updateHash();
			return true;
		});
	</script>
</body>
</html>
