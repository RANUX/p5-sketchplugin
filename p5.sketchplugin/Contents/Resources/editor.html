<!doctype html>
<html>

<head>
	<link rel="stylesheet" href="codemirror.css" />

	<script type="text/javascript" src="codemirror.js"></script>
	<script type="text/javascript" src="javascript.js"></script>
	<script type="text/javascript" src="jquery-3.2.1.min.js"></script>

	<style>
		body,
		html {
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
		}

		body {
			border: none;
			box-sizing: border-box;
		}

		button {
			width: 30px;
			height: 30px;
			border-radius: 15px;
			border: none;
			color: #ed225d;
			background-color: #f4f4f4;
		}

		button:hover {
			color: #f4f4f4;
			background-color: #ed225d;
		}

		.CodeMirror {
			height: 90%;
			width: 100%;
			border-top: 1px solid #ddd;
		}

		.header {
			height: 10%;
			font-family: Helvetica, Arial, sans-serif;
			font-size: 12px;
			margin-left: 10px;
		}

		.preset {
			float: right;
		}
	</style>
</head>

<body>
	<div class="header">
		<button onclick="updateHash()">&#9658;</button>
		<span class="preset">
			<span>Select from preset:</span><br>
		<select>
				<option value="latest">Latest code</option>
				<option value="basic">Basic sketch</option>
				<option value="pieChart">Pie chart</option>
				<option value="get">Get remote json</option>
			</select>
		</span>
	</div>
	<script type="text/javascript">
		//update the window.location hash to tell Sketch that we are ready to Run
		function updateHash() {
			window.location.hash = "run" + new Date().getTime();;
		}

		/*I tried to code this on the plugin side but without success. So the file is actually loaded in the editor by the webview*/
		function getLatest() {
			$.ajax({
			    url: "../Sketch/sketch.js",
			    cache: false,
			    error: function(XMLHttpRequest, textStatus, errorThrown){
							$('select').val("basic");
							setValue(defaultValue);
			    },
			    success: function(data){
						var code = data.replace(/\brectangle\b/g,'rect');
						console.log(code);
						setValue(code);
					}
			});
		};

		var options = {
			lineNumbers: true,
			autofocus: true,
			lineWrapping: true
		};
		var myCodeMirror = CodeMirror(document.body, options);

		var initialValue = getLatest();
		var defaultValue = "function setup() {\n	createCanvas(200, 200) //set up a 200x200 px artboard\n}\n\nfunction draw() {\n	line(0, 0, 100, 100);//draw a line from 0,0 to 100,100\n}"

		var getValue = function() {
			return myCodeMirror.getValue();
		};
		var setValue = function(value) {
			myCodeMirror.setValue(value);
		};

		var pieChart =`//The percentages you need to visualize
var percentages = [30,60,10];

function setup() {
  //Creates an 400x400 artboard
  createCanvas(400, 400);
  //Does not render Borders
  noStroke();
}

function draw() {
  //Custom function defined underneath
  pieChart(300, percentages);
}

//We define a function called pieChart that asks
//for diameter and percentage
function pieChart(diameter, data) {

  //We keep trak of the last angle drawn. The initial value
  //defines where the pie chart stars. -HALF_PI it 12 on a clock.
  var lastAngle = -HALF_PI;

  //We run a loop that runs as many times as there
  //are elements in the percentages array
  for (var i = 0; i < data.length; i++) {

    //Every time we run the loop we define a random rgb color
    //for each section of the pie
    fill(random(255),random(255),random(255));

    //We draw an arc that is centered at the center of the artboard,
    //has the first parameter of pieChart as a diameter
    //and takes one of the values from percentage, divides it by 100
    //multiplies it by 360 (so we get the percentage in degrees)
    //and then converts it into radians for angle
    //The variabile lastAngle is used to make sure we have arcs that
    //start where the last arc ended.
    arc(width/2, height/2, diameter, diameter, lastAngle,  lastAngle+radians((data[i]/100)*360));
    lastAngle += radians((data[i]/100)*360);
  }
}`;

		var get = `//Get a remote json and assign it to the var json
var json = get(['http://api.open-notify.org/astros.json'])

function setup() {
	createCanvas(200, 200)
}

function draw() {
  //remove Borders
  noStroke();
  //set Fills to black
  fill(0);
  //Set the title with a mix of static text and dynamic text.
  //If you do log(json) and check the macOS console youâ€™ll see
  //the content of the file. Dot notation gives you access to values
  text("Astronauts in space now: "+json.number,10,40,200,20);
  //Let's move a little bit down
  translate(0,65);
  	//Let's loop through the json.people and write out all the names
    for (x=0;x<json.people.length;x++) {
    //Tip: you can use the x value from the loop
    //to space names vertically
	text(json.people[x].name,10,x*15,200,20);
  }
}`;

		$('select').on('change', function() {
			if (this.value == "basic") {
				setValue(defaultValue);
			} else if (this.value == "latest") {
				getLatest();
			} else if (this.value == "pieChart") {
				setValue(pieChart);
			} else if (this.value == "get") {
				setValue(get);
			}
		});

		document.body.addEventListener('keydown', function(e) {
			if (!(e.keyCode == 13 && e.metaKey)) return;
			updateHash();
			return true;
		});
	</script>
</body>
</html>
